name: pr-deps-plotter
description: '✏️  Draw diagrams representing pull request dependencies.'
inputs:
  PR_URL:
    description: 'The URL to the pull request whose dependency tree to analyze.'
    required: true
  TOKEN:
    description: 'GitHub token to authenticate the action.'
    required: true
runs:
  using: composite
  steps:
    - name: Setup Graphviz
      uses: ts-graphviz/setup-graphviz@v1

    - name: Setup Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Verify dependencies
      shell: bash
      run: go mod verify

    - name: Run
      shell: bash
      run: |
        set -x
        PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
        [ PR_NUMBER = "main" ] && exit 0 || true
        sources=$(find src/ -name *.go -not \( -name *_test.go \))
        go run $sources ${{ inputs.PR_URL }} ${{ inputs.TOKEN }} | dot -Tpng >> /tmp/pr-deps-plotter.png
        upload_path=$(curl --upload-file /tmp/pr-deps-plotter.png https://transfer.sh/pr-deps-plotter.png)
        curl -H 'Authorization: Token ${{ inputs.TOKEN }}' -X POST \
          -d '{"body": "Dependency graph for this PR:\n[![PR Deps]('$(echo $upload_path)')]()\nImage hosted at: $upload_path"}' \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments"

